FROM node:16-alpine

WORKDIR /app

# Copy lock files if file exists
COPY ./package.json ./package-lock.json* ./

# Omit --production flag for devDependencies
RUN npm ci

COPY . /app

# Environment variables must be redefined at run time
ARG ONECADEMYCRED_TYPE
ARG ONECADEMYCRED_PROJECT_ID
ARG ONECADEMYCRED_PRIVATE_KEY_ID
ARG ONECADEMYCRED_PRIVATE_KEY
ARG ONECADEMYCRED_CLIENT_EMAIL
ARG ONECADEMYCRED_CLIENT_ID
ARG ONECADEMYCRED_AUTH_URI
ARG ONECADEMYCRED_TOKEN_URI
ARG ONECADEMYCRED_AUTH_PROVIDER_X509_CERT_URL
ARG ONECADEMYCRED_CLIENT_X509_CERT_URL
ARG GCSTORAGE_TYPE
ARG GCSTORAGE_PROJECT_ID
ARG GCSTORAGE_PRIVATE_KEY_ID
ARG GCSTORAGE_PRIVATE_KEY
ARG GCSTORAGE_CLIENT_EMAIL
ARG GCSTORAGE_CLIENT_ID
ARG GCSTORAGE_AUTH_URI
ARG GCSTORAGE_TOKEN_URI
ARG GCSTORAGE_AUTH_PROVIDER_X509_CERT_URL
ARG GCSTORAGE_CLIENT_X509_CERT_URL
ARG STATIC_STORAGE_BUCKET
ARG NEXT_PUBLIC_DATA_BASE_URL
ARG NEXT_PUBLIC_PROJECT_ID
ARG APP_URL


ENV ONECADEMYCRED_TYPE=${ONECADEMYCRED_TYPE}
ENV ONECADEMYCRED_PROJECT_ID=${ONECADEMYCRED_PROJECT_ID}
ENV ONECADEMYCRED_PRIVATE_KEY_ID=${ONECADEMYCRED_PRIVATE_KEY_ID}
ENV ONECADEMYCRED_PRIVATE_KEY=${ONECADEMYCRED_PRIVATE_KEY}
ENV ONECADEMYCRED_CLIENT_EMAIL=${ONECADEMYCRED_CLIENT_EMAIL}
ENV ONECADEMYCRED_CLIENT_ID=${ONECADEMYCRED_CLIENT_ID}
ENV ONECADEMYCRED_AUTH_URI=${ONECADEMYCRED_AUTH_URI}
ENV ONECADEMYCRED_TOKEN_URI=${ONECADEMYCRED_TOKEN_URI}
ENV ONECADEMYCRED_AUTH_PROVIDER_X509_CERT_URL=${ONECADEMYCRED_AUTH_PROVIDER_X509_CERT_URL}
ENV ONECADEMYCRED_CLIENT_X509_CERT_URL=${ONECADEMYCRED_CLIENT_X509_CERT_URL}
ENV GCSTORAGE_TYPE=${GCSTORAGE_TYPE}
ENV GCSTORAGE_PROJECT_ID=${GCSTORAGE_PROJECT_ID}
ENV GCSTORAGE_PRIVATE_KEY_ID=${GCSTORAGE_PRIVATE_KEY_ID}
ENV GCSTORAGE_PRIVATE_KEY=${GCSTORAGE_PRIVATE_KEY}
ENV GCSTORAGE_CLIENT_EMAIL=${GCSTORAGE_CLIENT_EMAIL}
ENV GCSTORAGE_CLIENT_ID=${GCSTORAGE_CLIENT_ID}
ENV GCSTORAGE_AUTH_URI=${GCSTORAGE_AUTH_URI}
ENV GCSTORAGE_TOKEN_URI=${GCSTORAGE_TOKEN_URI}
ENV GCSTORAGE_AUTH_PROVIDER_X509_CERT_URL=${GCSTORAGE_AUTH_PROVIDER_X509_CERT_URL}
ENV GCSTORAGE_CLIENT_X509_CERT_URL=${GCSTORAGE_CLIENT_X509_CERT_URL}
ENV STATIC_STORAGE_BUCKET=${STATIC_STORAGE_BUCKET}
ENV NEXT_PUBLIC_DATA_BASE_URL=${NEXT_PUBLIC_DATA_BASE_URL}
ENV NEXT_PUBLIC_PROJECT_ID=${NEXT_PUBLIC_PROJECT_ID}
ENV APP_URL=${APP_URL}

CMD ["npm", "run", "start"]
