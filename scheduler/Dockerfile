FROM node:16-alpine

WORKDIR /app

# Copy lock files if file exists
COPY ./scheduler/package.json ./scheduler/package-lock.json* ./

# Omit --production flag for TypeScript devDependencies
RUN npm ci

COPY ./scheduler ./

# Environment variables must be redefined at run time
ARG ONECADEMYCRED_TYPE
ARG NEXT_PUBLIC_PROJECT_ID
ARG ONECADEMYCRED_PRIVATE_KEY_ID
ARG ONECADEMYCRED_PRIVATE_KEY
ARG ONECADEMYCRED_CLIENT_EMAIL
ARG ONECADEMYCRED_CLIENT_ID
ARG ONECADEMYCRED_AUTH_URI
ARG ONECADEMYCRED_TOKEN_URI
ARG ONECADEMYCRED_AUTH_PROVIDER_X509_CERT_URL
ARG ONECADEMYCRED_CLIENT_X509_CERT_URL
ARG NEXT_PUBLIC_STORAGE_BUCKET
ARG ONECADEMYCRED_DATABASE_URL


ENV ONECADEMYCRED_TYPE=${ONECADEMYCRED_TYPE}
ENV NEXT_PUBLIC_PROJECT_ID=${NEXT_PUBLIC_PROJECT_ID}
ENV ONECADEMYCRED_PRIVATE_KEY_ID=${ONECADEMYCRED_PRIVATE_KEY_ID}
ENV ONECADEMYCRED_PRIVATE_KEY=${ONECADEMYCRED_PRIVATE_KEY}
ENV ONECADEMYCRED_CLIENT_EMAIL=${ONECADEMYCRED_CLIENT_EMAIL}
ENV ONECADEMYCRED_CLIENT_ID=${ONECADEMYCRED_CLIENT_ID}
ENV ONECADEMYCRED_AUTH_URI=${ONECADEMYCRED_AUTH_URI}
ENV ONECADEMYCRED_TOKEN_URI=${ONECADEMYCRED_TOKEN_URI}
ENV ONECADEMYCRED_AUTH_PROVIDER_X509_CERT_URL=${ONECADEMYCRED_AUTH_PROVIDER_X509_CERT_URL}
ENV ONECADEMYCRED_CLIENT_X509_CERT_URL=${ONECADEMYCRED_CLIENT_X509_CERT_URL}
ENV NEXT_PUBLIC_STORAGE_BUCKET=${NEXT_PUBLIC_STORAGE_BUCKET}
ENV NEXT_PUBLIC_DATA_BASE_URL=${NEXT_PUBLIC_DATA_BASE_URL}


CMD ["npm", "run", "start"]
